{"version":3,"file":"aja.js","sources":["../src/utils/util.ts","../src/store.ts","../src/aja.ts"],"sourcesContent":["\r\n/**\r\n * 获取DOM元素\r\n * @param s \r\n */\r\nexport function qs(s: string): Element | null {\r\n  return document.querySelector(s);\r\n}\r\n\r\n/**\r\n * [title]=\"title\"\r\n * @param value \r\n */\r\nexport function attrp(value: string) {\r\n  return /^\\[\\w.+\\]$/.test(value);\r\n}\r\n\r\n/**\r\n * (click)=\"hello('hello')\"\r\n */\r\nexport function eventp(value: string) {\r\n  return /^\\(\\w.+\\)$/.test(value);\r\n}\r\n\r\n/**\r\n * #input 模板变量\r\n * @param value \r\n */\r\nexport function tempvarp(value: string) {\r\n  return value[0] === \"#\";\r\n}\r\n","const l = console.log;\r\n\r\n/**\r\n * state 对象\r\n */\r\nexport interface State {\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * 事件函数对象\r\n */\r\nexport interface Actions {\r\n  [key: string]: Function;\r\n}\r\n\r\n/**\r\n * 计算函数\r\n */\r\nexport interface Computeds {\r\n  [key: string]: any;\r\n}\r\n\r\nexport interface Store {\r\n  state?: State;\r\n  actions?: Actions;\r\n  computeds?: Computeds;\r\n}\r\nconst listeners: Function[] = [];\r\n\r\nexport const autorun = (f: Function) => {\r\n  f();\r\n  listeners.push(f);\r\n};\r\n\r\nexport function createStore({ state, computeds, actions }: Store): any {\r\n  let _result: Object = {};\r\n  for (let k in state) {\r\n    // 将所有state，重新代理\r\n    Object.defineProperty(_result, k, {\r\n      get: function proxyGetter() {\r\n        let value;\r\n        if (typeof state[k] === \"object\") {\r\n          value = createStore({\r\n            state: state[k]\r\n          });\r\n        } else {\r\n          value = state[k];\r\n        }\r\n        return value;\r\n      },\r\n      set: function proxySetter(value) {\r\n        state[k] = value;\r\n        // 设置的时候调用回调\r\n        for (const f of listeners) {\r\n          f();\r\n        }\r\n      },\r\n      enumerable: true,\r\n      configurable: true\r\n    });\r\n  }\r\n  for (let k in computeds) {\r\n    Object.defineProperty(_result, k, {\r\n      get: function proxyGetter() {\r\n        return computeds[k].call(this);\r\n      }\r\n    });\r\n  }\r\n  Object.assign(_result, actions);\r\n  return _result;\r\n}\r\n","import { qs, attrp, eventp, tempvarp } from \"./utils/util\";\r\nimport { createStore, autorun, Computeds } from \"./store\";\r\n\r\nconst l = console.log;\r\n\r\nexport interface ModelData {\r\n  (): {\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\nexport interface ModelInterface {\r\n  readonly data?: ModelData;\r\n  readonly methods?: {\r\n    [key: string]: Function;\r\n  };\r\n  readonly computeds?: Computeds;\r\n}\r\nconst templateVariables: {\r\n  [key: string]: Element;\r\n} = {};\r\n\r\nexport class Aja {\r\n  // 扫描\r\n  static define(view: string | HTMLElement, model: ModelInterface) {\r\n    const _result = createStore({\r\n      state: model.data ? model.data() : {},\r\n      actions: model.methods ? model.methods : {},\r\n      computeds: model.computeds ? model.computeds : {}\r\n    });\r\n\r\n    const root =\r\n      typeof view === \"string\"\r\n        ? document.querySelector<HTMLElement>(view)\r\n        : view;\r\n    if (root === null) return;\r\n    Array.from(root.children).forEach(el => {\r\n      // 递归遍历\r\n      if (Array.from(el.children).length) {\r\n        return Aja.define(el as HTMLElement, model);\r\n      }\r\n      const attrs: Attr[] = Array.from(el.attributes) || [];\r\n      for (let attr of attrs) {\r\n        let key = attr.name;\r\n        let value = attr.value;\r\n        if (attrp(key)) {\r\n          // [title]=\"title\"\r\n          let len = key.length;\r\n          let name = key.substr(1, len - 2); // [title] -> title\r\n          autorun(() => {\r\n            if (name === \"style\") {\r\n              const styles: CSSStyleDeclaration = _result[value];\r\n              for (const key in styles) {\r\n                const _isNaN = isNaN(parseInt(key));\r\n                if (\r\n                  _isNaN &&\r\n                  Object.getOwnPropertyDescriptor(\r\n                    (el as HTMLElement).style,\r\n                    key\r\n                  )\r\n                ) {\r\n                  const _value = styles[key];\r\n                  if (_value) {\r\n                    (el as HTMLElement).style[key] = _value;\r\n                  }\r\n                }\r\n              }\r\n            } else {\r\n              el.setAttribute(name, _result[value]); // 属性扫描绑定\r\n            }\r\n          });\r\n        }\r\n        if (eventp(key)) {\r\n          // 绑定的事件: (click)=\"echo('hello',$event)\"\r\n          let len = key.length;\r\n          let name = key.substr(1, len - 2); // (click) -> click\r\n\r\n          // 函数名\r\n          let funcName: string;\r\n          // 函数参数\r\n          let args: any[];\r\n          if (value.includes(\"(\")) {\r\n            // 带参数的函数\r\n            let index = value.indexOf(\"(\");\r\n            funcName = value.substr(0, index);\r\n            args = value\r\n              .substr(index, value.length - 2)\r\n              .replace(/(^\\(*)|(\\))/g, \"\")\r\n              .split(\",\")\r\n              .map(a => a.trim());\r\n            // l(args)\r\n          } else {\r\n            funcName = value;\r\n          }\r\n          el.addEventListener(name, function(e) {\r\n            args = args.map(el => (el === \"$event\" ? e : el));\r\n            if (funcName in _result) {\r\n              return _result[funcName](...args);\r\n            }\r\n          });\r\n        }\r\n        if (tempvarp(key)) {\r\n          // 模板变量 #input\r\n          templateVariables[key.replace(/^#/, \"\")] = el;\r\n        } else {\r\n          // l(\"绑定的静态数据\", attrName)\r\n        }\r\n\r\n        // TODO 处理for指令\r\n        if (key === \"*for\") {\r\n          // 循环遍历\r\n          //   l(key, value);\r\n          let [varb, d] = value.split(\"in\").map(s => s.trim());\r\n          if (typeof +d === \"number\") {\r\n            const fragment = document.createDocumentFragment();\r\n            const parent = el.parentNode;\r\n            for (let index = 0; index < +d; index++) {\r\n              if (parent) parent.appendChild(el.cloneNode(true));\r\n            }\r\n          } else {\r\n          }\r\n        }\r\n\r\n        // TODO 处理if指令\r\n        if (key === \"*if\") {\r\n        }\r\n      }\r\n      // 插值表达式 {{ name }} {{ obj.age }}\r\n\r\n      if (el.textContent) {\r\n        const exp = /{{([\\w\\s\\.][\\s\\w\\.]+)}}/g;\r\n        if (exp.test(el.textContent)) {\r\n          const _initTextContent = el.textContent;\r\n          autorun(() => {\r\n            const text = _initTextContent.replace(exp, function(match) {\r\n              var key = Array.prototype.slice\r\n                .call(arguments, 1)[0]\r\n                .replace(/\\s/g, \"\");\r\n              let keys = key.split(\".\");\r\n              let data: any;\r\n              // 在data中找数据\r\n              for (const el of keys) {\r\n                data = data ? data[el] : _result[el];\r\n              }\r\n\r\n              // 没有在data中找到数据, 寻找模板变量里面\r\n              if (data === undefined) {\r\n                // TODO 模板变量双向绑定\r\n                const isTemplateVariables = keys[0] in templateVariables;\r\n                if (isTemplateVariables) {\r\n                  for (const el of keys) {\r\n                    data = data ? data[el] : templateVariables[el];\r\n                  }\r\n                }\r\n              }\r\n              return data;\r\n            });\r\n            el.textContent = text;\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return _result;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}